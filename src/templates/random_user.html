{% extends "base.html" %}

{% block title %}Random User{% endblock %}
{% block description %}Get a random user from our external API.{% endblock %}

{% block content %}
<div class="header-section">
  <h1>Random User Generator</h1>
  <p>Demonstrating external API integration with FastAPI and Background Tasks.</p>
</div>

<!-- Main Interaction Area -->
<div class="card" style="max-width: 600px; margin: 0 auto;">
  <div style="text-align: center; padding: 2rem;">
    <div id="user-display" style="display: none; margin-bottom: 2rem;">
      <img id="user-image" src="" alt="Random User"
        style="width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--primary-color); margin-bottom: 1rem; object-fit: cover;">
      <h2 id="user-name" style="margin-bottom: 0.5rem;"></h2>
      <p id="user-email" style="color: var(--text-muted); margin-bottom: 0.5rem;"></p>
      <p id="user-location" style="font-size: 0.9rem;"></p>
    </div>

    <div id="initial-state" style="margin-bottom: 2rem; color: var(--text-muted);">
      <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ‘¤</div>
      <p>Click the button below to fetch a random user.</p>
    </div>

    <!-- Button for authenticated users -->
    <button id="fetch-user-btn" class="btn btn-primary btn-lg" style="display: none;">
      Get Random User
    </button>

    <!-- Message for unauthenticated users -->
    <div id="sign-in-prompt" style="display: none;">
      <p style="color: var(--text-muted); margin-bottom: 1rem;">Please sign in to use this feature.</p>
      <a href="/login" class="btn btn-primary btn-lg">Sign In</a>
    </div>
  </div>
</div>

<div style="margin-top: 2rem; text-align: center;">
  <p style="color: var(--text-muted); font-size: 0.9rem;">
    Data provided by <a href="https://randomuser.me" target="_blank">randomuser.me</a> via our backend proxy.
  </p>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const fetchBtn = document.getElementById('fetch-user-btn');
    const signInPrompt = document.getElementById('sign-in-prompt');
    const userDisplay = document.getElementById('user-display');
    const initialState = document.getElementById('initial-state');
    const imgEl = document.getElementById('user-image');
    const nameEl = document.getElementById('user-name');
    const emailEl = document.getElementById('user-email');
    const locationEl = document.getElementById('user-location');

    // Check authentication and show appropriate UI
    if (window.TokenManager && window.TokenManager.isAuthenticated()) {
      fetchBtn.style.display = 'inline-block';
      signInPrompt.style.display = 'none';

      fetchBtn.addEventListener('click', async () => {
        const originalText = fetchBtn.textContent;
        fetchBtn.disabled = true;
        fetchBtn.textContent = 'Fetching...';

        try {
          // Use the API helper from main.js
          const response = await API.get('/v1/external/random-user');
          const userData = response.data.results[0];

          // Update UI
          imgEl.src = userData.picture.large;
          nameEl.textContent = `${userData.name.first} ${userData.name.last}`;
          emailEl.textContent = userData.email;
          locationEl.textContent = `${userData.location.city}, ${userData.location.country}`;

          // Show display, hide initial state
          initialState.style.display = 'none';
          userDisplay.style.display = 'block';

        } catch (error) {
          console.error('Error fetching user:', error);

          if (error.status === 429) {
            // Extract retry_after from details if available
            const details = error.data?.detail?.details; // Adjusted based on exceptions.py structure
            const retryAfter = details?.retry_after;

            let msg = 'Rate limit reached.';
            if (retryAfter) {
              msg += ` Please wait ${retryAfter} seconds.`;
            } else {
              msg += ' Please try again later.';
            }

            window.showFlash(msg, 'error');
          }
          // Other errors might be handled by global handlers or ignored here
        } finally {
          fetchBtn.disabled = false;
          fetchBtn.textContent = originalText;
        }
      });
    } else {
      // Not authenticated - show sign in prompt
      fetchBtn.style.display = 'none';
      signInPrompt.style.display = 'block';
    }
  });
</script>
{% endblock %}