{% extends "base.html" %}

{% block title %}Listing Details{% endblock %}

{% block content %}
<div id="listing-content">
  <div class="text-center" style="padding: 3rem;">
    <div class="spinner" style="margin: 0 auto;"></div>
    <p class="mt-1 text-muted">Loading listing...</p>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const listingId = {{ listing_id }};

  document.addEventListener('DOMContentLoaded', loadListing);

  async function loadListing() {
    const container = document.getElementById('listing-content');

    try {
      const listing = await API.get(`/v1/listings/${listingId}`);
      const user = TokenManager.getUser();
      const isOwner = user && (user.id === listing.seller_id || user.role === 'admin');

      container.innerHTML = `
            <div class="d-flex justify-between align-center mb-2">
                <a href="/listings" class="btn btn-secondary btn-sm">&larr; Back to Listings</a>
                ${isOwner ? `
                    <div class="d-flex gap-1">
                        <a href="/listings/${listing.id}/edit" class="btn btn-secondary btn-sm">Edit</a>
                        <button onclick="handleDeleteListing(${listing.id})" class="btn btn-danger btn-sm">Delete</button>
                    </div>
                ` : ''}
            </div>
            
            <div class="card">
                <div class="d-flex justify-between align-center mb-2">
                    <span class="listing-category">${listing.category || 'Uncategorized'}</span>
                    ${listing.is_active
          ? '<span class="badge badge-success">Active</span>'
          : '<span class="badge badge-warning">Inactive</span>'}
                </div>
                
                <h1 style="margin-bottom: 0.5rem;">${escapeHtml(listing.title)}</h1>
                
                <div class="listing-price" style="margin-bottom: 1.5rem;">$${listing.price.toFixed(2)}</div>
                
                <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
                    <h3>Description</h3>
                    <p class="text-secondary" style="white-space: pre-wrap;">${escapeHtml(listing.description || 'No description provided.')}</p>
                </div>
                
                <div class="listing-meta" style="margin-top: 2rem;">
                    <span>Seller ID: ${listing.seller_id}</span>
                    <span>Listed: ${formatDate(listing.created_at)}</span>
                </div>
            </div>
        `;

    } catch (error) {
      if (error.status === 404) {
        container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <h3>Listing Not Found</h3>
                    <p>This listing may have been removed or doesn't exist.</p>
                    <a href="/listings" class="btn btn-primary mt-2">Browse Listings</a>
                </div>
            `;
      } else {
        container.innerHTML = `
                <div class="alert alert-error">
                    Failed to load listing. Please try again.
                </div>
            `;
      }
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', {
      month: 'long',
      day: 'numeric',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
</script>
{% endblock %}