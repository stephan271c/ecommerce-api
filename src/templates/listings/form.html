{% extends "base.html" %}

{% block title %}{% if listing_id %}Edit Listing{% else %}New Listing{% endif %}{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto;">
  <a href="/listings" class="btn btn-secondary btn-sm mb-2">&larr; Back to Listings</a>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">{% if listing_id %}Edit Listing{% else %}Create New Listing{% endif %}</h2>
    </div>

    <form id="{% if listing_id %}update-listing-form{% else %}create-listing-form{% endif %}" {% if listing_id %}
      data-listing-id="{{ listing_id }}" {% endif %}>
      <div class="form-group">
        <label class="form-label" for="title">Title *</label>
        <input type="text" id="title" name="title" class="form-control" placeholder="Product title" required
          maxlength="200">
      </div>

      <div class="form-group">
        <label class="form-label" for="description">Description</label>
        <textarea id="description" name="description" class="form-control" placeholder="Describe your product..."
          rows="5"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label" for="price">Price *</label>
        <input type="number" id="price" name="price" class="form-control" placeholder="0.00" required min="0"
          step="0.01">
      </div>

      <div class="form-group">
        <label class="form-label" for="category">Category</label>
        <select id="category" name="category" class="form-control">
          <option value="">Select a category</option>
          <option value="electronics">Electronics</option>
          <option value="clothing">Clothing</option>
          <option value="home">Home & Garden</option>
          <option value="books">Books</option>
          <option value="sports">Sports</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="is_active" name="is_active" checked style="width: auto;">
          <span>Active (visible to buyers)</span>
        </label>
      </div>

      <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
        {% if listing_id %}Save Changes{% else %}Create Listing{% endif %}
      </button>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Check authentication
    if (!TokenManager.isAuthenticated()) {
      showFlash('Please login to create or edit listings', 'warning');
      setTimeout(() => window.location.href = '/login', 1500);
      return;
    }

    {% if listing_id %}
    // Load existing listing data for editing
    loadListingData();
    {% endif %}
  });

  {% if listing_id %}
  async function loadListingData() {
    try {
      const listing = await API.get('/v1/listings/{{ listing_id }}');

      // Check ownership
      const user = TokenManager.getUser();
      if (!user || (user.id !== listing.seller_id && user.role !== 'admin')) {
        showFlash('You can only edit your own listings', 'error');
        setTimeout(() => window.location.href = '/listings/{{ listing_id }}', 1500);
        return;
      }

      // Populate form
      document.getElementById('title').value = listing.title;
      document.getElementById('description').value = listing.description || '';
      document.getElementById('price').value = listing.price;
      document.getElementById('category').value = listing.category || '';
      document.getElementById('is_active').checked = listing.is_active;

    } catch (error) {
      showFlash('Failed to load listing', 'error');
      setTimeout(() => window.location.href = '/listings', 1500);
    }
  }
  {% endif %}
</script>
{% endblock %}